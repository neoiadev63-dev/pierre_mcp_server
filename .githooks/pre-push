#!/bin/bash
# ABOUTME: Git pre-push hook - Checks for validation marker before allowing push
# ABOUTME: Requires running ./scripts/ci/pre-push-validate.sh first (prevents SSH timeout)
#
# SPDX-License-Identifier: MIT OR Apache-2.0
# Copyright (c) 2025 Pierre Fitness Intelligence

set -e

PROJECT_ROOT="$(git rev-parse --show-toplevel)"
GIT_DIR="$(git rev-parse --git-dir)"
MARKER_FILE="$GIT_DIR/validation-passed"
VALIDATION_TTL_MINUTES=15

# Check if this is a delete operation (no validation needed)
ZERO_SHA="0000000000000000000000000000000000000000"
IS_DELETE=true

while read -r local_ref local_sha remote_ref remote_sha; do
    if [ "$local_sha" != "$ZERO_SHA" ]; then
        IS_DELETE=false
        break
    fi
done

if [ "$IS_DELETE" = true ]; then
    echo "üóëÔ∏è  Branch delete operation - skipping validation"
    exit 0
fi

# Get current commit
CURRENT_COMMIT=$(git rev-parse HEAD)
CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)

# Function to print validation required message
print_validation_required() {
    local reason="$1"
    echo ""
    echo "üö´ Push blocked - validation required"
    echo "======================================"
    echo ""
    echo "Reason: $reason"
    echo ""
    echo "Run validation first:"
    echo "  ./scripts/ci/pre-push-validate.sh"
    echo ""
    echo "Then push:"
    echo "  git push"
    echo ""
    echo "To bypass (NOT RECOMMENDED):"
    echo "  git push --no-verify"
    echo ""
    exit 1
}

# Check if marker file exists
if [ ! -f "$MARKER_FILE" ]; then
    print_validation_required "No validation marker found"
fi

# Read marker file (format: timestamp commit_hash)
MARKER_CONTENT=$(cat "$MARKER_FILE")
MARKER_TIMESTAMP=$(echo "$MARKER_CONTENT" | cut -d' ' -f1)
MARKER_COMMIT=$(echo "$MARKER_CONTENT" | cut -d' ' -f2)

# Check if marker is fresh (within TTL)
CURRENT_TIMESTAMP=$(date +%s)
AGE_SECONDS=$((CURRENT_TIMESTAMP - MARKER_TIMESTAMP))
AGE_MINUTES=$((AGE_SECONDS / 60))
TTL_SECONDS=$((VALIDATION_TTL_MINUTES * 60))

if [ "$AGE_SECONDS" -gt "$TTL_SECONDS" ]; then
    print_validation_required "Validation expired (${AGE_MINUTES} minutes old, TTL is ${VALIDATION_TTL_MINUTES} minutes)"
fi

# Check if commit matches (no new commits since validation)
if [ "$MARKER_COMMIT" != "$CURRENT_COMMIT" ]; then
    print_validation_required "Commit changed since validation (validated: ${MARKER_COMMIT:0:8}, current: ${CURRENT_COMMIT:0:8})"
fi

# Check for in-flight workflows and suggest cancellation
check_inflight_workflows() {
    if ! command -v gh &> /dev/null; then
        return 0
    fi

    REMOTE_URL=$(git remote get-url origin 2>/dev/null || echo "")
    if [ -z "$REMOTE_URL" ]; then
        return 0
    fi

    REPO_SLUG=$(echo "$REMOTE_URL" | sed -E 's|.*github\.com[:/]([^/]+/[^/.]+)(\.git)?$|\1|')
    if [ -z "$REPO_SLUG" ]; then
        return 0
    fi

    IN_PROGRESS_RUNS=$(gh run list --repo "$REPO_SLUG" --branch "$CURRENT_BRANCH" --status in_progress --json databaseId --jq '.[].databaseId' 2>/dev/null || echo "")
    QUEUED_RUNS=$(gh run list --repo "$REPO_SLUG" --branch "$CURRENT_BRANCH" --status queued --json databaseId --jq '.[].databaseId' 2>/dev/null || echo "")

    ALL_RUNS="$IN_PROGRESS_RUNS $QUEUED_RUNS"
    RUN_COUNT=0
    RUN_IDS=""

    for run_id in $ALL_RUNS; do
        if [ -n "$run_id" ]; then
            RUN_COUNT=$((RUN_COUNT + 1))
            RUN_IDS="$RUN_IDS $run_id"
        fi
    done

    if [ "$RUN_COUNT" -gt 0 ]; then
        echo ""
        echo "‚ö†Ô∏è  Found $RUN_COUNT in-flight workflow(s) on branch '$CURRENT_BRANCH'"
        echo ""
        echo "   Consider cancelling stale workflows after push:"
        for run_id in $RUN_IDS; do
            echo "   gh run cancel $run_id --repo $REPO_SLUG"
        done
        echo ""
    fi
}

# All checks passed
echo ""
echo "‚úÖ Validation marker found and valid"
echo "   Validated: ${AGE_MINUTES}m ago"
echo "   Commit:    ${CURRENT_COMMIT:0:8}"
echo ""

# Check for in-flight workflows
check_inflight_workflows

echo "üöÄ Push proceeding..."
echo ""

# Delete marker - validation consumed. If push fails, re-run validation.
rm -f "$MARKER_FILE"
