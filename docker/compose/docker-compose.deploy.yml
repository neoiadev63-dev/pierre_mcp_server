services:
  # ============================================================
  # PostgreSQL Database (internal only)
  # ============================================================
  postgres:
    image: postgres:16-alpine
    container_name: pierre-postgres
    restart: always
    environment:
      POSTGRES_USER: pierre
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:?Set POSTGRES_PASSWORD in .env}
      POSTGRES_DB: pierre_mcp_server
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ../init/postgres:/docker-entrypoint-initdb.d
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U pierre -d pierre_mcp_server"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      - pierre-internal
    deploy:
      resources:
        limits:
          memory: 512M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ============================================================
  # Pierre MCP Server (Rust Backend - internal only)
  # ============================================================
  pierre-server:
    build:
      context: ../..
      dockerfile: docker/images/server/Dockerfile.prod
    image: pierre-mcp-server:latest
    container_name: pierre-server
    restart: always
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      # Database
      DATABASE_URL: postgresql://pierre:${POSTGRES_PASSWORD}@postgres:5432/pierre_mcp_server
      POSTGRES_MAX_CONNECTIONS: "10"
      POSTGRES_MIN_CONNECTIONS: "2"
      POSTGRES_ACQUIRE_TIMEOUT: "30"
      # Server
      HOST: "0.0.0.0"
      HTTP_PORT: "8081"
      RUST_LOG: ${RUST_LOG:-info}
      # Security
      PIERRE_MASTER_ENCRYPTION_KEY: ${PIERRE_MASTER_ENCRYPTION_KEY:?Set PIERRE_MASTER_ENCRYPTION_KEY}
      PIERRE_RSA_KEY_SIZE: "4096"
      JWT_EXPIRY_HOURS: "24"
      SESSION_COOKIE_SECURE: "false"
      # Provider OAuth
      PIERRE_DEFAULT_PROVIDER: ${PIERRE_DEFAULT_PROVIDER:-strava}
      PIERRE_STRAVA_CLIENT_ID: ${PIERRE_STRAVA_CLIENT_ID:-}
      PIERRE_STRAVA_CLIENT_SECRET: ${PIERRE_STRAVA_CLIENT_SECRET:-}
      STRAVA_CLIENT_ID: ${PIERRE_STRAVA_CLIENT_ID:-}
      STRAVA_CLIENT_SECRET: ${PIERRE_STRAVA_CLIENT_SECRET:-}
      STRAVA_REDIRECT_URI: ${STRAVA_REDIRECT_URI:-}
      GARMIN_EMAIL: ${GARMIN_EMAIL:-}
      GARMIN_PASSWORD: ${GARMIN_PASSWORD:-}
      PIERRE_GARMIN_CLIENT_ID: ${PIERRE_GARMIN_CLIENT_ID:-}
      PIERRE_GARMIN_CLIENT_SECRET: ${PIERRE_GARMIN_CLIENT_SECRET:-}
      # LLM
      PIERRE_LLM_PROVIDER: ${PIERRE_LLM_PROVIDER:-gemini}
      GEMINI_API_KEY: ${GEMINI_API_KEY:-}
      PIERRE_LLM_DEFAULT_MODEL: ${PIERRE_LLM_DEFAULT_MODEL:-gemini-2.5-flash}
      PIERRE_LLM_FALLBACK_MODEL: ${PIERRE_LLM_FALLBACK_MODEL:-gemini-2.5-flash}
      # Admin
      ADMIN_EMAIL: ${ADMIN_EMAIL:-admin@pierre.mcp}
      ADMIN_PASSWORD: ${ADMIN_PASSWORD:-}
    volumes:
      - pierre_data:/app/data
    networks:
      - pierre-internal
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8081/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    deploy:
      resources:
        limits:
          cpus: "1.5"
          memory: 512M
    logging:
      driver: "json-file"
      options:
        max-size: "20m"
        max-file: "5"

  # ============================================================
  # Nginx - Reverse Proxy + Frontend (port 8081 exposed)
  # ============================================================
  nginx:
    image: nginx:alpine
    container_name: pierre-nginx
    restart: always
    depends_on:
      pierre-server:
        condition: service_healthy
    ports:
      - "8081:80"
    volumes:
      - ../nginx/nginx.conf:/etc/nginx/conf.d/default.conf:ro
      - frontend_dist:/usr/share/nginx/html:ro
    networks:
      - pierre-internal
    deploy:
      resources:
        limits:
          memory: 128M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ============================================================
  # Frontend files copier (init container - runs once)
  # ============================================================
  frontend-init:
    image: pierre-mcp-server:latest
    container_name: pierre-frontend-init
    user: root
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        echo "Copying frontend files to shared volume..."
        rm -rf /frontend/*
        cp -r /app/frontend/dist/* /frontend/
        echo "Done. Files copied:"
        ls -la /frontend/
    volumes:
      - frontend_dist:/frontend
    restart: "no"
    networks:
      - pierre-internal

  # ============================================================
  # PostgreSQL Backup (every 6 hours)
  # ============================================================
  backup:
    image: postgres:16-alpine
    container_name: pierre-backup
    restart: always
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      PGHOST: postgres
      PGUSER: pierre
      PGPASSWORD: ${POSTGRES_PASSWORD}
      PGDATABASE: pierre_mcp_server
    volumes:
      - backup_data:/backups
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        while true; do
          timestamp=$$(date +%Y%m%d_%H%M%S)
          echo "[$$timestamp] Starting backup..."
          pg_dump -Fc > /backups/pierre_$$timestamp.dump
          echo "[$$timestamp] Backup created: pierre_$$timestamp.dump"
          find /backups -name "pierre_*.dump" -mtime +7 -delete
          sleep 21600
        done
    networks:
      - pierre-internal
    deploy:
      resources:
        limits:
          memory: 128M

volumes:
  postgres_data:
    driver: local
  pierre_data:
    driver: local
  frontend_dist:
    driver: local
  backup_data:
    driver: local

networks:
  pierre-internal:
    driver: bridge
